name: Function App CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'
  pull_request:
    branches:
      - main

env:
  DOTNET_VERSION: '9.0.x'
  CONFIGURATION: 'Release'
  FUNCAPP_NAME: 'Holonet-Func-Databank-8108'
  RESOURCE_GROUP: 'Holonet'
  APP_PROJECT: './src/Holonet.Databank.AppFunctions/Holonet.Databank.AppFunctions.csproj'
  PUBLISH_DIR: 'publish'

jobs:
  build-and-deploy:
    name: Build, Publish, Deploy (.NET 9 Isolated)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
            dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore ${{ env.APP_PROJECT }}

      - name: Build
        run: dotnet build ${{ env.APP_PROJECT }} -c ${{ env.CONFIGURATION }} --no-restore

      - name: Publish
        run: dotnet publish ${{ env.APP_PROJECT }} -c ${{ env.CONFIGURATION }} -o ${{ env.PUBLISH_DIR }} --no-build --verbosity normal

      - name: Zip published output
        run: |
          cd ${{ env.PUBLISH_DIR }}
          zip -r ../app.zip *

      - name: Verify zip contents
        run: |
          cd ${{ env.PUBLISH_DIR }}
          zip -r ../app.zip *
          cd ..
          unzip -l app.zip | head -20

      - name: Login to Azure
        uses: azure/login@v2
        with:
          # If using federated credentials, ensure the Azure AD app is configured;
          # otherwise remove 'id-token: write' permission above and use a secret-based SP:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy via OneDeploy (zip)
        run: |
          az functionapp deployment source config-zip \
            --name ${{ env.FUNCAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --src app.zip
            
      - name: Configure Function App Runtime
        run: |
          az functionapp config appsettings set \
            --name ${{ env.FUNCAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --settings FUNCTIONS_WORKER_RUNTIME=dotnet-isolated FUNCTIONS_EXTENSION_VERSION=~4 DOTNET_ISOLATED_VERSION=9.0

      - name: Post-deploy validation (Optional)
        run: |
          az functionapp show -g ${{ env.RESOURCE_GROUP }} -n ${{ env.FUNCAPP_NAME }} --query "state"
          echo "Deployed; check Application Insights for cold start/logs."

      - name: Restart Function App
        run: |
          az functionapp restart \
            --name ${{ env.FUNCAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }}
